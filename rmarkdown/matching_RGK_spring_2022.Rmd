---
title: "CONNECT Program Matching"
description: |
  University of Texas at Austin, Spring 2022 
author:
  - name: Ethan Tenison 
    affiliation: RGK Center for Philanthropy and Community Service 
    affiliation_url: https://rgkcenter.org/
date: "`r format(Sys.Date(), '%B %d, %Y') `"
output:
  distill::distill_article:
    code_folding: yes
    toc: yes
    toc_float: yes
    theme: theme.css
  pdf_document: default
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
library(tidyverse)  #A collection of packages that use the same grammar and structure
library(qualtRics)  #For connecting to Qualtrics API
library(Hmisc)      #Helpful for annotations and labels
library(matchingR)  #Contains Gale-Shapley Algorithm
library(kableExtra) #Package for creating customizable tables
library(janitor)    #data cleaning package
library(labelled)   #Also dealing with labels
library(plotly)     #For interactive ploting
library(htmltools)  #for html widgets 


knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

```

Every semester the CONNECT Program pairs community organizations with graduate students with data and evaluation skills. As the program has expanded, the matching process has become more complicated, necessitating improved program efficiency. The following document outlines how survey data is taken from Qualtrics, cleaned and sorted, and then matched using the Gale-Shapley Algorithm. Some descriptive data visualizations were included as well to give program managers a snap shot of the semester cohort. 


```{r stu, message=FALSE, warning=FALSE, echo=FALSE, results='hide'}

stu <- read_csv("data/raw/CONNECT_rgk_students_spring2022.csv") |> 
  select(-c(1:17)) |> 
  filter(!row_number() %in% c(2)) |> 
  janitor::row_to_names(1) |> 
  clean_names() |> 
  rename(pronouns = preferred_pronouns_selected_choice,
         phone = phone_number_please_do_not_include_hyphens_or_parentheses,
         relevant_skills = do_you_have_other_relevant_skills_that_may_be_helpful_for_us_to_know_about_i_e_other_languages_spoken_list_them_here_note_separate_each_skill_with_a_comma,
         target_population = every_semester_the_connect_program_works_with_organizations_that_serve_many_different_target_populations_are_there_any_specific_populations_that_youre_interested_in_working_with,
         nonprofit_experience = over_the_past_5_years_approximately_how_much_experience_have_you_had_working_or_directly_volunteering_with_nonprofit_organizations,
         schools = which_ut_schools_colleges_are_you_affiliated_with_check_all_that_apply_selected_choice,
         schools_other = which_ut_schools_colleges_are_you_affiliated_with_check_all_that_apply_other_text,
         international = to_comply_with_university_rules_and_regulations_please_indicate_if_you_are_an_international_student_please_note_that_this_does_not_prohibit_participation_in_this_program) |> 
  rename_with(~ gsub('please_rate_your_experience_in_the_following_technical_skills_note_1_not_experienced_and_5_extremely_experienced_', '', .x))
  

```

```{r org, message=FALSE, warning=FALSE, echo=FALSE, results='hide'}

org <- read_csv("data/raw/CONNECT_organization_spring2022.csv") |> 
  select(-c(1:17)) |> 
  filter(!row_number() %in% c(2)) |> 
  janitor::row_to_names(1) |> 
  clean_names() |> 
  rename_with(~ gsub('please_rate_how_relevant_the_following_technical_skills_are_to_your_project_', '', .x)) |> 
  rename(nonprofit_experience = "how_much_experience_working_or_volunteering_with_nonprofits_should_your_candidate_have_working_or_volunteering_for_nonprofits") |> 
  filter(which_connect_program_is_this_project_affiliated_with == "RGK Center")


```


# Project Wordcloud

Project CONNECT continues to offer a diverse set of projects to students. The word cloud below shows the most common words located in the project deliverable section. What's clear about this cohort is that data is king, and we a wide variety of projects and deliverables. 

```{r project_deliverables, fig.width=8, message=FALSE, warning=FALSE}
library(wordcloud)
library(RColorBrewer)
library(tm) # to create corpus
library(wordcloud2)
library(htmlwidgets)
  

# Create a vector containing only the text
text <- org$project_deliverables

# Create a corpus
docs <- Corpus(VectorSource(text))

# standardize corpus
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
docs <- tm_map(docs, content_transformer(tolower))
docs <- tm_map(docs, removeWords, stopwords("english"))

# create a document matrix
dtm <- TermDocumentMatrix(docs)
matrix <- as.matrix(dtm)
words <- sort(rowSums(matrix), decreasing = TRUE)
df <- data.frame(word = names(words), freq = words)
df$word <- as.character(df$word)
target <- c("also", "project", "really", "helpful", "able", "helped", "felt", "wasnt", "etc", "asks", "move", "gave")
"%ni%" <- Negate("%in%")
df <- filter(df, word %ni% target)
df$word <- as.factor(df$word)

set.seed(27)


w1 <-
  wordcloud2(data = df,
             color = rep_len(
               c("#264653", "#2A9D8F", "#E9C46A", "#F4A261", "#E76F51"),
               nrow(df)
             ),
             shuffle = FALSE)


w1
```
# Project Description Table 

Each project is unique, and some are more complex than others. When you are evaluating who should be placed with what organizations, it's important to keep in my the project goals and deliverables, even if they end up changing. The table below was pulled directly from the organization surveys, and it outlines the project goals, deliverables, and extra considerations. 

```{r project_desc, message=FALSE, warning=FALSE, layout="l-body-outset"}
proj_des <- org |>
  select(
    project_name,
    project_goal,
    project_deliverables,
    what_other_relevant_skills_would_be_helpful_for_your_candidate_to_have_i_e_other_languages_spoken_coding_analytical_software_professional_skills_etc_list_them_here
  ) |>
  rename(
    Project = project_name,
    Goal = project_goal,
    Deliverables = project_deliverables,
    "Other Considerations" = what_other_relevant_skills_would_be_helpful_for_your_candidate_to_have_i_e_other_languages_spoken_coding_analytical_software_professional_skills_etc_list_them_here
  ) |> 
  arrange(Project) |> 
  mutate(`Other Considerations` = replace_na(`Other Considerations`, ""),
         Deliverables = gsub('(\\s\\d)\\)', '<br><br>\\1\\.', Deliverables))


kbl(proj_des, escape = F) |> 
  kable_minimal("hover", full_width = T) |> 
  scroll_box(width = "100%", height = "600px")
```
</br>

# Project Buckets

There were `r length(org$organization)` projects, but some of them involve multiple buckets. Of note, this semester there were zero web design projects. Projects that were continuations from previous semester, or were pre-matched were also not included. 


```{r project_buckets, fig.height=4, fig.width=8, message=FALSE, warning=FALSE}
buckets <- org |>
  select(organization, 29:34) |>
  pivot_longer(col = 2:7,
               names_to = "bucket_",
               values_to = "bucket") |>
  select(organization, bucket) |>
  drop_na() |>
  group_by(bucket) |> 
  count() |> 
  mutate(bucket = case_when(
    bucket == "Data Collection & Tool Development" ~ "Data Collection &\n Tool Development",
    bucket == "Data Interpretation & Analysis" ~ "Data Interpretation &\n Analysis",
    bucket == "Business Intelligence & Advanced Analytics" ~ "Business Intelligence &\n Advanced Analytics",
    TRUE ~ bucket
  )) |> 
  arrange(n)


theme_set(theme_classic())

g <- ggplot(buckets, aes(x = reorder(bucket, n), y = n)) +
  geom_bar(stat = "identity", fill = "#2A9D8F") +
    geom_text(aes(label = n, y = n),
    position = position_stack(vjust = 0.5),
    size = 8) +
  coord_flip()+
   theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_blank(),
     text = element_text(
                         size = 16,
                         face = "bold"),
     axis.title.x = element_blank(),
     axis.title.y = element_blank(),
     axis.ticks = element_blank(),
      axis.text.x=element_blank(),
     plot.title = element_text(hjust = 0.5),
     plot.margin = margin(10, 10, 10, 10),
     legend.title = element_blank(),
     legend.position = "none",
     
   ) +
  labs(title = "CONNECT Fall 2021 Project buckets", y = "Number", fill = "Buckets") 


g


```

# Student Skills

The following chart was constructed by counting every student who put at least a 2 under each skill. The most popular skills were Microsoft Office Suite and program evaluation skills. Those that selected outcomes definition and logic modeling were much fewer in comparison to program evaluation. Therefore, it might make sense next semester to remove program evaluation and focus on specific program evaluation skills. 

```{r student_skills, fig.height=6, fig.width=8, message=FALSE, warning=FALSE}

stu <- stu_raw
colnames(stu) <- label(stu)

stu <- stu |>
  clean_names() |>
  filter(progress == 100) |>
  select(first_name, 64:88)

names(stu) <-
  gsub(pattern = "please_rate_your_experience_in_the_following_technical_skills_note_1_not_experienced_and_5_extremely_experienced_",
       replacement = "",
       x = names(stu))

names(stu) <- gsub(pattern = "_",
                   replacement = " ",
                   x = names(stu))

names(stu) <- str_to_title(names(stu))

stu2 <- stu |>
  pivot_longer(col = 2:26,
               names_to = "Skill",
               values_to = "Rating") |>
  #Setting students who put 1 to NA
  mutate(Rating = na_if(Rating, 1)) |>
  drop_na() |>
  group_by(Skill) |>
  count()

theme_set(theme_classic())

g <- ggplot(stu2, aes(x = reorder(Skill, n), y = n)) +
  geom_bar(stat = "identity", fill = "#F4A261") +
  geom_text(aes(label = n, y = n),
            position = position_stack(vjust = 0.5),
            size = 6) +
  coord_flip() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_blank(),
    text = element_text(size = 16,
                        face = "bold"),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks = element_blank(),
    axis.text.x = element_blank(),
    plot.title = element_text(hjust = 0.5),
    plot.margin = margin(10, 10, 10, 10),
    legend.title = element_blank(),
    legend.position = "none"
    
  ) +
  labs(title = "CONNECT Fall 2021 Student Skills")


g

```


# Organization Data 

Ordinal questions for both student and organization surveys were converted to a numeric scale. For example, for the question "How much working or volunteering with nonprofits should your candidate have?" the responses were converted from 1 to 5, with "No experience required" being 1 and "2 or more years" being 5. This is done because the algorithm can only compare numeric values.  

```{r org_cleaning, message=FALSE, warning=FALSE, layout="l-body-outset"}
org <- org_raw

#Assigning variable names
colnames(org) <- label(org)


org <- org |>
  clean_names() |>
  #Specify here which school to filter by
  filter(which_connect_program_is_this_project_affiliated_with == "RGK Center") |>
  rename(
    time_commitment = realistically_how_much_time_do_you_expect_your_student_to_commit_per_week_working_on_your_assigned_project,
    transportation = does_your_candidate_need_to_have_access_to_transportation,
    flexible_hours = will_your_project_permit_flexible_work_hours,
    remote = will_your_candidate_be_able_to_work_remotely,
    nonprofit_experience = how_much_experience_working_or_volunteering_with_nonprofits_should_your_candidate_have_working_or_volunteering_for_nonprofits
  ) 


org_mapping <- org |>
  select(organization,
        organization_address,
        organization_website
        )
  
org <- org |>
  select(
    organization,
    project_name,
    project_goal,
    project_deliverables,
    transportation,
    flexible_hours,
    remote,
    time_commitment,
    nonprofit_experience,
    40:64
  ) |>
  mutate(
    nonprofit_experience = case_when(
      nonprofit_experience == "No experience required" ~ "1",
      nonprofit_experience == "Less than 6 months" ~ "2",
      nonprofit_experience == "6 - 12 months" ~ "3",
      nonprofit_experience == "1 - 2 years" ~ "4",
      nonprofit_experience == "2 or more years" ~ "5",
    ),
    time_commitment = case_when(
      time_commitment == "Less than 5 hours per week" ~ "1",
      time_commitment == "5 - 10 hours per week" ~ "2",
      time_commitment == "8 - 12 hours per week" ~ "3",
      time_commitment == "10 - 15 hours per week" ~ "4",
      time_commitment == "15 - 20 hours per week" ~ "5"
    )
  ) |>
  arrange(project_name)


names(org) <-
  gsub(pattern = "please_rate_how_relevant_the_following_technical_skills_are_to_your_project_",
       replacement = "",
       x = names(org))

org <- data.frame(lapply(org, function(x) {
  gsub("1 - Not relevant", "1", x)
}))

org <- data.frame(lapply(org, function(x) {
  gsub("5 - Extremely relevant", "5", x)
}))


org <- org |>
  mutate(across(8:34, as.numeric))

#For Table
org_table <- org |>
  select(-c(organization, project_deliverables, project_goal))

names(org_table) <- gsub(pattern = "_",
                         replacement = " ",
                         x = names(org_table))

names(org_table) <- str_to_title(names(org_table))

cell_color <- function(x) {
  x = cell_spec(x,
                color = spec_color(x, end = .7),
                bold = T,)
}

org_table <- org_table |>
  select(-Transportation, -`Flexible Hours`,-Remote, everything()) |>
  mutate(across(2:28, cell_color))

kbl(org_table, escape = F) |>
  kable_material(c("hover", "striped", "condensed"), full_width = F) |>
  scroll_box(width = "100%", height = "400px")
```

<b style='color: #E76F51 !important;' align="center"> Overall, `r length(org$organization)` organizations were included in this cohort. </b>
</br>

```{r org_skill_fix, message=FALSE, warning=FALSE, include=FALSE}

org <- org |> 
  mutate(microsoft_office_suite = case_when(
    organization == "Austin Asian Impact" ~ 3,
    TRUE ~ microsoft_office_suite
  ), 
  power_bi = case_when(
    organization == "Austin Asian Impact" ~ 5,
    TRUE ~ power_bi
  ),
  python = case_when(
    organization == "Austin Asian Impact" ~ 3,
    organization == "Andy Roddick Foundation" ~ 3,
    TRUE ~ python
  ),
  google_data_studio = case_when(
    organization == "Bastrop County Cares" ~ 5,
    TRUE ~ google_data_studio
  ),
  r_shiny = case_when(
    organization == "PelotonU" ~ 5,
    TRUE ~ r_shiny
  ))





```


# Student Data 

Because CONNECT uses a formalized survey structure, the data cleaning process for student and organization survey data is virtually the same. The table below includes student skills and experience ratings as well as answers from logistics questions. 

```{r org_clean, message=FALSE, warning=FALSE, layout="l-body-outset"}

stu <- stu_raw

colnames(stu) <- label(stu)

stu <- stu |> 
  clean_names() |> 
  filter(progress == 100) |> 
  select(
    first_name,
    last_name,
    is_there_any_additional_information_regarding_your_availability_that_we_should_know_about,
    do_you_have_access_to_transportation,
    do_you_need_flexible_work_hours,
    do_you_need_the_ability_to_work_remotely,
    realistically_how_much_time_can_you_commit_per_week_to_working_on_a_project,
    over_the_past_5_years_approximately_how_much_experience_have_you_had_working_or_directly_volunteering_with_nonprofit_organizations,
    64:90
  ) |>
    rename(
      time_commitment = realistically_how_much_time_can_you_commit_per_week_to_working_on_a_project,
      transportation = do_you_have_access_to_transportation,
      flexible_hours = do_you_need_flexible_work_hours, 
      remote = do_you_need_the_ability_to_work_remotely,
      nonprofit_experience = over_the_past_5_years_approximately_how_much_experience_have_you_had_working_or_directly_volunteering_with_nonprofit_organizations,
      relevant_skills = do_you_have_other_relevant_skills_that_may_be_helpful_for_us_to_know_about_i_e_other_languages_spoken_list_them_here_note_separate_each_skill_with_a_comma,
      target_population = every_semester_the_connect_program_works_with_organizations_that_serve_many_different_target_populations_are_there_any_specific_populations_that_youre_interested_in_working_with
    ) |> 
  mutate(nonprofit_experience = case_when(
    nonprofit_experience == "No experience (yet!)" ~ "1",
    nonprofit_experience == "Less than 6 months" ~ "2",
    nonprofit_experience == "6 - 12 months" ~ "3",
    nonprofit_experience == "1 - 2 years" ~ "4",
    nonprofit_experience == "2 or more years" ~ "5",
  )) 

names(stu) <- gsub(pattern = "please_rate_your_experience_in_the_following_technical_skills_note_1_not_experienced_and_5_extremely_experienced_",
                  replacement = "",
                  x = names(stu))

stu$time_commitment[stu$time_commitment == "Less than 5 hours per week"] <- "1"
stu$time_commitment[stu$time_commitment == "5 - 10 hours per week"] <- "2"
stu$time_commitment[stu$time_commitment == "8 - 12 hours per week"] <- "3"
stu$time_commitment[stu$time_commitment == "10 - 15 hours per week"] <- "4"
stu$time_commitment[stu$time_commitment == "15 - 20 hours per week"] <- "5"

stu <- stu |> 
  mutate(across(7:33, as.numeric)) |> 
  mutate(name = paste0(first_name," ", last_name)) |> 
  select(name, time_commitment, 4:35) |>  
  arrange(str_extract(name,'\\s.*$'))


#For table 
stu_table <- stu |> 
  select(-c(relevant_skills, target_population))

names(stu_table) <- gsub(pattern = "_",
                  replacement = " ",
                  x = names(stu_table))

names(stu_table) <- str_to_title(names(stu_table))


cell_color <- function(x) {
  x = cell_spec(x,
                color = spec_color(x, end = .7),
                bold = T,
                )
}

stu_table <- stu_table |> 
  select(-Transportation,-`Flexible Hours`, -Remote, everything()) |> 
  mutate(across(2:28, cell_color))


kbl(stu_table, escape = F) |> 
  kable_material(c("hover", "striped", "condensed"), full_width = F) |> 
  scroll_box(width = "100%", height = "400px")

```

<b style='color: #E76F51 !important;' align="center"> Overall, `r length(stu$name)` students applied during this cohort. </b>
</br>

### Other student information 

The following table includes students' responses to open ended questions. It's impossible to list every single skill that might be relevant for a project on the survey (although we have tried), so the relevant skills question is attempt to fill that gap. In addition, for the first time a question about target population was added to the survey. This came out of our diversity, equity, and inclusion evaluation that was conducted during our summer cohort. Students voiced their desire to specify which populations they are most interested in. As an open ended question, we can not use target population in the algorithm in its present state. However, we will have the opportunity to improve the question methodology in subsequent cohorts to give students more of a say in the organizations they work with. 

```{r desired_pop, message=FALSE, warning=FALSE, layout="l-body-outset"}
stu_table2 <- stu |> 
  select(name, relevant_skills, target_population) |> 
  mutate(relevant_skills = replace_na(relevant_skills, ""),
         target_population = replace_na(target_population, ""))

names(stu_table2) <- gsub(pattern = "_",
                  replacement = " ",
                  x = names(stu_table2))

names(stu_table2) <- str_to_title(names(stu_table2))

kbl(stu_table2, escape = F) |> 
  kable_minimal(c("hover"), full_width = F) |> 
  scroll_box(width = "100%", height = "400px")

```

# Prematches

```{r prematches}

org <- org |> 
  filter(organization != "Community Advancement Network" |
           organization != "Impact Austin" |
           organization != "Urban School Food Alliance")

stu <- stu |> 
  filter(name != "Agnes Elimbi Moudio" |
           name != "Niina Nomura" |
           name != "Sidney Beaty")

Organization <- c("Community Advancement Network",
          "Impact Austin",
          "Urban School Food Alliance")

Student <- c("Agnes Elimbi Moudio",
            "Niina Nomura",
            "Sidney Beaty")

prematched <- data.frame(Organization, Student)  
  
kbl(prematched , escape = F) |> 
  kable_material(c("hover", "striped"), full_width = F)


```


# Utility Score Formulation 

In order to use the matching Algorithm, students and organizations have to be assigned a utility ratings. These ratings are formulated by comparing how similar the students' skills and nonprofit experience are to the project expectations. 

Each student receives a utility score for each organization, and each organization is assigned a utility sore for each student. This ensures that both the student's and organization's rankings are taken into account for the matching process. For example, if an organization assigns two students the same utility score, but one student has a higher utility score for that organization, this student is selected and the other student returns to the selection pool. 

### Utility Score Example 

The following section illustrates how utility scores are formulated. The code block below was used to calculate `r stu[1,1]`'s utility rating for `r org[1,1]`. Each skill is compared by subtracting the student value from the organization's. If the result equals 0 or greater, that means the student's skill rating meets or exceeds what the organization's project requires and the skill receives a utility rating of 1. If the result is a negative number, that means the organizations requirements exceed what the student put on their survey form, and they receive a utility rating less than one, depending on how far the student's answer was from the organizations. 

Additionally, if a student put a 1 on a skill, which means they have no background in it, they automatically receive a zero utility rating. Students who don't match the organization based on the logistics questions, also receive a utility rating of zero. 

Finally, all of the skill utility ratings are added up to produce one utility rating for `r stu[1,1]` and `r org[1,1]`. The higher the number, the greater the utility the student will have for that project. 

```{r testing_utility, echo=TRUE, message=FALSE, warning=FALSE}

#Initial Data Manipulation
org1 <- org[1, ] |>
  pivot_longer(9:34, names_to = "variable", values_to = "org_value")
stu1 <- stu[1, ] |>
  pivot_longer(6:31, names_to = "variable", values_to = "student_value")

#Assigning a utility score for each skill
match1 <- left_join(org1, stu1, by = "variable") |>
  mutate(
    subtracted = student_value - org_value,
    utility = case_when(
      subtracted >= 0 ~ 1,
      subtracted == -1 ~ .75,
      subtracted == -2 ~ .5,
      subtracted == -3 ~ .25,
      subtracted == -4 ~ 0
    ),
    #if the student put 1 on their survey it means
    #they would provide 0 utility for that skills 
    utility = case_when(
      student_value == 1 ~ 0,
      TRUE ~ utility),
    #If the students logistics don't match up with the orgs
    #Then the utility for that student changes to 0
    utility = case_when(
      transportation.x == "Yes" & transportation.y == "No" ~ 0,
      flexible_hours.x == "No" & flexible_hours.y == "Yes" ~ 0,
      remote.x == "No" & remote.y == "Yes" ~ 0,
      TRUE ~ utility
    ),#If the orgs time commitment is greater than what the student
    #is willing to work their utility is set to 0
    utility = case_when(
      time_commitment.x > time_commitment.y ~ 0,
      TRUE ~ utility
    )
  ) 

utility_score <- sum(match1$utility)
print(paste0(stu[1,1],"'s utility for ",org[1,1], ": ", utility_score))
```



```{r student_utility, message=FALSE, warning=FALSE, include=FALSE}

#utility students                                    
column_names <- stu$name
row_names <- org$organization

uS <- matrix(nrow = length(org$project_name),
             ncol = length(stu$name),
             dimnames = list(row_names, column_names))

for (i in 1:length(org$project_name)) {
  for (j in 1:length(stu$name)) {
    org1 <- org[i, ] |>
      pivot_longer(9:34, names_to = "variable", values_to = "org_value")
    
    stu1 <- stu[j, ] |>
      pivot_longer(6:31, names_to = "variable", values_to = "student_value")
    
    match1 <- left_join(org1, stu1, by = "variable") |>
      mutate(
        subtracted = student_value - org_value,
        utility = case_when(
          subtracted >= 0 ~ 1,
          subtracted == -1 ~ .75,
          subtracted == -2 ~ .5,
          subtracted == -3 ~ .25,
          subtracted <= -4 ~ 0
        ),
        utility = case_when(
          student_value == 1 ~ 0,
          TRUE ~ utility),
        utility = case_when(
          transportation.x == "Yes" & transportation.y == "No" ~ 0,
          flexible_hours.x == "No" & flexible_hours.y == "Yes" ~ 0,
          remote.x == "No" & remote.y == "Yes" ~ 0,
          TRUE ~ utility
        ),
        utility = case_when(time_commitment.x > time_commitment.y ~ 0,
                            TRUE ~ utility)
      )
    
    utility_score <- sum(match1$utility)
    uS[i,j] <- utility_score
  }
  
}

kbl(uS, escape = F) |> 
  kable_material(c("hover", "striped", "condensed"), full_width = F) |> 
  scroll_box(width = "100%", height = "400px")

```
### Organization Utility Scores

For simplicity sake, only the organization utility scores are shown below because their preference matters more in the event of an unsuitable first match. Higher organization utility scores mean that the student is better suited to the organization's project. These ratings can be validated by reviewing students resumes when necessary.


```{r org_utility, message=FALSE, warning=FALSE, layout="l-body-outset"}
#utility organizations  
row_names <- stu$name
column_names <- org$project_name

uO <- matrix(nrow = length(stu$name),
             ncol = length(org$project_name),
             dimnames = list(row_names, column_names))


for (j in 1:length(stu$name)) {
  for (i in 1:length(org$project_name)) {
    org1 <- org[i,] |>
      pivot_longer(9:34, names_to = "variable", values_to = "org_value")
    
    stu1 <- stu[j,] |>
      pivot_longer(6:31, names_to = "variable", values_to = "student_value")
    
    match1 <- left_join(org1, stu1, by = "variable") |>
      mutate(
        subtracted =  org_value - student_value,
        utility = case_when(
          subtracted <= 0 ~ 1,
          subtracted == 1 ~ .75,
          subtracted == 2 ~ .5,
          subtracted == 3 ~ .25,
          subtracted >= 4 ~ 0
        ),
        utility = case_when(
          org_value == 1 ~ 0,
          TRUE ~ utility),
        utility = case_when(
          transportation.x == "Yes" & transportation.y == "No" ~ 0,
          flexible_hours.x == "No" & flexible_hours.y == "Yes" ~ 0,
          remote.x == "No" & remote.y == "Yes" ~ 0,
          TRUE ~ utility
        ),
        utility = case_when(time_commitment.x > time_commitment.y ~ 0,
                            TRUE ~ utility)
      )
    
    utility_score <- sum(match1$utility)
    uO[j, i] <- utility_score
  }
}

#Table Styling 
cell_color <- function(x) {
  x = cell_spec(x,
                color = spec_color(x, end = .7),
                bold = T,
                )
}


uO_table <- as.data.frame(uO) |> 
  mutate(across(1:9, cell_color))


kbl(uO_table, escape = F) |> 
  kable_material(c("hover", "striped", "condensed"), full_width = F) |> 
  scroll_box(width = "100%", height = "400px")
```
</br>

# The Gale Shapley Algorithm

The `matchingR` package was used to quickly compute the Gale-Shapley algorithm. The algorithm was devised to create satisfactory matches between two parties, in this case between organizations and students. It has been used commercially on match making websites, in college admissions, and by the healthcare industry to match organ donors with organ recipients. The former being the major impetus for the creators to receive the Nobel Prize in Economics in 2012. You can find a full description of the package and literature behind the Gale-Shapley algorithm [here](https://cran.r-project.org/web/packages/matchingR/vignettes/matchingR-intro.html).

```{r gale_shapley, echo=FALSE, message=TRUE, warning=FALSE}

#Matching Algorithm 
library(matchingR)
matching = galeShapley.marriageMarket(uS, uO)


```

# Matching Results

The table below shows the matching results. Matches should be validated by reviewing student resumes to ensure they have relevant work experience. The table also shows a list of all the top scorers for each project. Program managers can use this list to help them find a match if the first wasn't suitable.

```{r results, message=FALSE, warning=FALSE, layout="l-body-outset"}

#Creating a list of top scorers
uO2 <- as.data.frame(uO)
org_options <- tibble::rownames_to_column(uO2, "Student") 
tops <- list()

for (i in 2:ncol(org_options)) {
  org_top <- org_options |> 
    slice_max(org_options[,i], n = 3)
  
tops[[i]] <- paste(org_top$Student, collapse=", ") 
}

tops <- tops[-1]
top_df <- data.frame(matrix(unlist(tops), nrow=length(tops), byrow=TRUE))

top_df$matrix.unlist.tops...nrow...length.tops...byrow...TRUE.<-
  gsub("\\."," ",top_df$matrix.unlist.tops...nrow...length.tops...byrow...TRUE.)

#Creating a data frame for table 
org_info <- org |> 
  select(project_name)

students_matched <- stu |> 
  slice(matching$engagements) |> 
  bind_cols(org_info) |>  
  bind_cols(top_df) |> 
  rename(Student = name, 
         Project = project_name,
         "Top Scores" = "matrix.unlist.tops...nrow...length.tops...byrow...TRUE.") |> 
  select(Project, Student,"Top Scores")
  

var_label(students_matched$Project) <- NULL


  
kbl(students_matched) |> 
  kable_material(c("hover","striped"), full_width = F) |> 
  scroll_box(width = "100%", height = "600px")

```


<br>
<br>
<br>

<img src="C:/Users/tenis/Desktop/Data_Projects/connect_matching/reports/RGB_formal_RGK.png" alt="RGK Center">

