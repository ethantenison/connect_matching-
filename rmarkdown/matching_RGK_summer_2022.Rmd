---
title: "CONNECT Program Matching"
description: |
  University of Texas at Austin, Summer 2022 
author:
  - name: Ethan Tenison 
    affiliation: RGK Center for Philanthropy and Community Service 
    affiliation_url: https://rgkcenter.org/
date: "`r format(Sys.Date(), '%B %d, %Y') `"
output:
  distill::distill_article:
    code_folding: yes
    toc: yes
    toc_float: yes
    theme: theme.css
  pdf_document: default
  word_document:
    toc: yes
---

```{r setup, include=FALSE}
library(tidyverse)  #A collection of packages that use the same grammar and structure
library(qualtRics)  #For connecting to Qualtrics API
library(Hmisc)      #Helpful for annotations and labels
library(matchingR)  #Contains Gale-Shapley Algorithm
library(kableExtra) #Package for creating customizable tables
library(janitor)    #data cleaning package
library(labelled)   #Also dealing with labels
library(plotly)     #For interactive ploting
library(htmltools)  #for html widgets 
library(matchingR)  #for gale shapley 
library(tidymodels) #for ml
library(tidytext)   #for nlp
library(pdftools)   #converting pdfs
library(textrecipes) #nlp processing
library(discrim)   
library(yaml)      #saving models


knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file())

```

Every semester the CONNECT Program pairs community organizations with graduate students with data and evaluation skills. As the program has expanded, the matching process has become more complicated, necessitating improved program efficiency. The following document outlines how survey data is taken from Qualtrics, cleaned and sorted, and then matched using the Gale-Shapley Algorithm. Some descriptive data visualizations were included as well to give program managers a snap shot of the semester cohort. 

# Qualtrics

Using the `qualtRics` package the organization and student surveys were pulled directly from Qualtrics. In order to connect to the Qualtrics API, you must have UT staff privileges. Any UT student must have their privileges updated by contacting UT IT Services. Your Qualtrics API can be accessed through account settings in the "Qualtrics IDs" section. 

```{r qualtrics, message=FALSE, warning=FALSE, echo=TRUE, results='hide'}

# Connecting to the Qualtrics API
# There's always problem with the api. Make sure they haven't changed your key.....
# set your api key using Sys.setenv("NAME" = "API KEY")
# qualtrics_api_credentials(
# api_key = Sys.getenv("qualtrics_key"), 
# base_url = "ca1.qualtrics.com"
# )

#Pulling the organization and students surveys 
surveys <- all_surveys() 

#Finding the row index for organization and student surveys
stu_number <- which(surveys$name=="10.CONNECT- Summer 2022", arr.ind=TRUE)
org_number <- which(surveys$name=="Matching Form_Summer 2022", arr.ind=TRUE)

#Fetching the Survey Contents 
org_raw <- fetch_survey(surveyID = surveys$id[org_number], force_request = TRUE)
stu_raw <- fetch_survey(surveyID = surveys$id[stu_number], force_request = TRUE)

```

# Projects

### Project Wordcloud


Project CONNECT continues to offer a diverse set of projects to students. The word cloud below shows the most common words located in the project deliverable section. What's clear about this cohort is that data is king, and we a wide variety of projects and deliverables. 

```{r project_deliverables, fig.width=8, message=FALSE, warning=FALSE}
library(wordcloud)
library(RColorBrewer)
library(tm) # to create corpus
library(wordcloud2)
library(htmlwidgets)

org <- org_raw
colnames(org) <- label(org)
org <- org |>
  clean_names() 
  

# Create a vector containing only the text
text <- org$project_deliverables

# Create a corpus
docs <- Corpus(VectorSource(text))

# standardize corpus
docs <- docs %>%
  tm_map(removeNumbers) %>%
  tm_map(removePunctuation) %>%
  tm_map(stripWhitespace)
docs <- tm_map(docs, content_transformer(tolower))
docs <- tm_map(docs, removeWords, stopwords("english"))

# create a document matrix
dtm <- TermDocumentMatrix(docs)
matrix <- as.matrix(dtm)
words <- sort(rowSums(matrix), decreasing = TRUE)
df <- data.frame(word = names(words), freq = words)
df$word <- as.character(df$word)
target <- c("also", "project", "really", "helpful", "able", "helped", "felt", "wasnt", "etc", "asks", "move", "gave")
"%ni%" <- Negate("%in%")
df <- filter(df, word %ni% target)
df$word <- as.factor(df$word)

set.seed(27)


w1 <-
  wordcloud2(data = df,
             color = rep_len(
               c("#264653", "#2A9D8F", "#E9C46A", "#F4A261", "#E76F51"),
               nrow(df)
             ),
             shuffle = FALSE)

w1

```


### Project Descriptions 

Each project is unique, and some are more complex than others. When you are evaluating who should be placed with what organizations, it's important to keep in my the project goals and deliverables, even if they end up changing. The table below was pulled directly from the organization surveys, and it outlines the project goals, deliverables, and extra considerations. 


```{r project_desc, message=FALSE, warning=FALSE, layout="l-body-outset"}

org2 <- org |> 
  rename_with(~ gsub('please_rate_how_relevant_the_following_technical_skills_are_to_your_project_', '', .x)) |> 
  rename_with(~ gsub('please_rate_how_relevant_the_following_evaluation_consulting_and_language_skills_are_to_your_project_', '', .x)) |> 
  rename(nonprofit_experience = "how_much_experience_working_or_volunteering_with_nonprofits_should_your_candidate_have_working_or_volunteering_for_nonprofits",
             time_commitment = realistically_how_much_time_do_you_expect_your_student_to_commit_per_week_working_on_your_assigned_project,
    transportation = does_your_candidate_need_to_have_access_to_transportation,
    flexible_hours = will_your_project_permit_flexible_work_hours,
    remote = will_your_candidate_be_able_to_work_remotely) 

proj_des <- org2 |>
  select(
    project_name,
    project_goal,
    project_deliverables,
    what_other_relevant_skills_would_be_helpful_for_your_candidate_to_have_i_e_other_languages_spoken_coding_analytical_software_professional_skills_etc_list_them_here
  ) |>
  rename(
    Project = project_name,
    Goal = project_goal,
    Deliverables = project_deliverables,
    "Other Considerations" = what_other_relevant_skills_would_be_helpful_for_your_candidate_to_have_i_e_other_languages_spoken_coding_analytical_software_professional_skills_etc_list_them_here
  ) |> 
  arrange(Project) |> 
  mutate(`Other Considerations` = replace_na(`Other Considerations`, ""),
         Deliverables = gsub('(\\s\\d)\\)', '<br><br>\\1\\.', Deliverables)) 


kbl(proj_des, escape = F) |> 
  kable_minimal("hover", full_width = T) |> 
  scroll_box(width = "100%", height = "600px")
```

</br>

### Organization Data 

Ordinal questions for both student and organization surveys were converted to a numeric scale. For example, for the question "How much working or volunteering with nonprofits should your candidate have?" the responses were converted from 1 to 5, with "No experience required" being 1 and "2 or more years" being 5. This is done because the algorithm can only compare numeric values.  

```{r org_cleaning, message=FALSE, warning=FALSE, layout="l-body-outset"}

org_mapping <- org2 |>
  select(organization,
        organization_address,
        organization_website
        )
org3 <- org2 |>
  select(
    organization,
    project_name,
    project_goal,
    project_deliverables,
    transportation,
    flexible_hours,
    remote,
    time_commitment,
    nonprofit_experience,
    45:69
  ) |>
  rename("spanish" = "please_indicate_how_relevant_the_proficiency_with_the_following_languages_is_to_your_project_note_1_language_proficiency_not_required_and_5_native_speaker_required_spanish") |> 
  mutate(
    nonprofit_experience = case_when(
      nonprofit_experience == "No experience required" ~ "1",
      nonprofit_experience == "Less than 6 months" ~ "2",
      nonprofit_experience == "6 - 12 months" ~ "3",
      nonprofit_experience == "1 - 2 years" ~ "4",
      nonprofit_experience == "2 or more years" ~ "5",
      TRUE ~ nonprofit_experience
    ),
    time_commitment = case_when(
      time_commitment == "Less than 5 hours per week" ~ "1",
      time_commitment == "5 - 10 hours per week" ~ "2",
      time_commitment == "8 - 12 hours per week" ~ "3",
      time_commitment == "10 - 15 hours per week" ~ "4",
      time_commitment == "15 - 20 hours per week" ~ "5"
    )
  ) |>
  arrange(project_name) |> 
  mutate(across(9:34,~gsub("1 - Not relevant", "1", .)),
         across(9:34,~gsub("5 - Extremely relevant", "5", .)),
         across(8:34, as.numeric))


#For Table
org_table <- org3 |>
  select(-c(organization, project_deliverables, project_goal))

names(org_table) <- gsub(pattern = "_",
                         replacement = " ",
                         x = names(org_table))

names(org_table) <- str_to_title(names(org_table))

cell_color <- function(x) {
  x = cell_spec(x,
                color = spec_color(x, end = .7),
                bold = T,)
}

org_table <- org_table |>
  select(-Transportation, -`Flexible Hours`,-Remote, everything()) |>
  mutate(across(2:28, cell_color))

kbl(org_table, escape = F) |>
  kable_material(c("hover", "striped", "condensed"), full_width = F) |>
  scroll_box(width = "100%", height = "400px")
```

<b style='color: #E76F51 !important;' align="center"> Overall, `r length(org$organization)` organizations were included in this cohort. </b>
</br>

### Project Buckets

There were `r length(org$organization)` projects, but some of them involve multiple buckets. Of note, this semester there were zero web design projects. Projects that were continuations from previous semester, or were pre-matched were also not included. 


```{r project_buckets, fig.height=4, fig.width=8, message=FALSE, warning=FALSE}

buckets <- org2 |> 
  select(organization, starts_with("identify_the_categories")) |> 
   rename_with(~ gsub('identify_the_categories_your_project_falls_under_check_all_that_apply_', '', .x)) |>
  pivot_longer(cols = 2:7, names_to = "bucket", values_to = "value") |> 
  filter(!is.na(value)) |> 
  group_by(value) |> 
  count() |> 
  mutate(n = as.numeric(n),
         value = case_when(
      value == "Data Collection & Tool Development" ~ "Data Collection &\n Tool Development",
      value == "Data Interpretation & Analysis" ~ "Data Interpretation &\n Analysis",
      value == "Business Intelligence & Advanced Analytics" ~ "Business Intelligence &\n Advanced Analytics",
      TRUE ~ value
    )) |> 
  arrange(n)


theme_set(theme_classic())

g <- ggplot(buckets, aes(x = reorder(value, n), y = n)) +
  geom_bar(stat = "identity", fill = "#2A9D8F") +
    geom_text(aes(label = n, y = n),
    position = position_stack(vjust = 0.5),
    size = 8) +
  coord_flip()+
   theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_blank(),
     text = element_text(
                         size = 16,
                         face = "bold"),
     axis.title.x = element_blank(),
     axis.title.y = element_blank(),
     axis.ticks = element_blank(),
      axis.text.x=element_blank(),
     plot.title = element_text(hjust = 0.5),
     plot.margin = margin(10, 10, 10, 10),
     legend.title = element_blank(),
     legend.position = "none",
     
   ) +
  labs(title = "Project buckets",
       y = "Number",
       fill = "Buckets",
       caption = "**Several projects had two+ categories") 


g


```
### Organization Location 

```{r org_location}
library(ggmap)
library(leaflet)
register_google(Sys.getenv("google_geocode_key"))

geo_o <- org2 |> 
  filter(!is.na(organization_address)) |> 
  select(organization, organization_address) |> 
  mutate(organization_address = case_when(
    organization_address == "N/A" ~ "",
    TRUE ~ organization_address
  )) |> 
  distinct(organization_address, .keep_all = TRUE) |> 
  mutate_geocode(organization_address)

# create leaflet map
org_map <- leaflet(geo_o) %>%
  addTiles() %>%
  addMarkers(lng = ~ lon,
             lat = ~ lat,
             popup = ~ organization)

org_map


```


# Students

### Student Data 

Because CONNECT uses a formalized survey structure, the data cleaning process for student and organization survey data is virtually the same. The table below includes student skills and experience ratings as well as answers from logistics questions. 

```{r org_clean, message=FALSE, warning=FALSE, layout="l-body-outset"}

stu <- stu_raw

colnames(stu) <- label(stu)
stu <- stu |> 
  clean_names() |> 
  rename(pronouns = preferred_pronouns_selected_choice,
         phone = phone_number_please_do_not_include_hyphens_or_parentheses,
         relevant_skills = do_you_have_other_relevant_skills_or_previous_experience_that_may_be_helpful_for_us_to_know_about_i_e_other_languages_spoken_courses_youvetaken_or_will_be_enrolled_in_this_summer_list_them_here_note_separate_each_skill_with_a_comma,
         target_population = every_semester_the_connect_program_works_with_organizations_that_serve_many_different_target_populations_are_there_any_specific_populations_that_youre_interested_in_working_with,
         nonprofit_experience = over_the_past_5_years_approximately_how_much_experience_have_you_had_working_or_directly_volunteering_with_nonprofit_organizations,
         international = to_comply_with_university_rules_and_regulations_please_indicate_if_you_are_an_international_student_please_note_that_this_does_not_prohibit_participation_in_this_program) |> 
  rename_with(~ gsub('please_rate_your_experience_with_the_following_technical_skills_note_1_not_experienced_and_5_extremely_experienced_', '', .x)) |> 
  rename_with(~ gsub('please_rate_your_experience_with_the_following_consulting_and_evaluation_skills_note_1_not_experienced_and_5_extremely_experienced_', '', .x)) |>
  rename_with(~ gsub('which_of_the_following_best_describes_your_race_ethnicity_select_all_that_apply_selected_choice_', '', .x) ) 


race <- stu |> 
  select(first_name, last_name, 93:103) |> 
  mutate(name = paste0(first_name," ", last_name)) |> 
  select(name, everything(),-c(first_name, last_name, i_prefer_to_specify)) |> 
  pivot_longer(cols=2:11, names_to = "ra_e", values_to = "race_ethnicity") |> 
  filter(!is.na(race_ethnicity)) |> 
  select(-ra_e)

race_plot <- race |> 
  group_by(race_ethnicity) |> 
  count() |> 
  arrange(n)


r <- ggplot(race_plot, aes(x = reorder(race_ethnicity, n), y = n)) +
  geom_bar(stat = "identity", fill = "#2A9D8F") +
    geom_text(aes(label = n, y = n),
    position = position_stack(vjust = 0.5),
    size = 8) +
  coord_flip()+
   theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_blank(),
     text = element_text(
                         size = 16,
                         face = "bold"),
     axis.title.x = element_blank(),
     axis.title.y = element_blank(),
     axis.ticks = element_blank(),
     plot.title = element_text(hjust = 0.5),
     plot.margin = margin(10, 10, 10, 10),
     legend.title = element_blank(),
     legend.position = "none",
     
   ) +
  labs(title = "Student Race/Ethnicity",
       y = "Number",
       caption = "**Several students had multiple identities") 


r


```


```{r more_cleaning}
  
#add together ethnicity for those that selected multiple
race$race_ethnicity[race$name == "Enrique Leon"] <- "Hispanic or Latino, Mestizo"
race$race_ethnicity[race$name == "Francisco Castellanos-Sosa"] <- "Hispanic or Latino, White or Caucasian"
race$race_ethnicity[race$name == "James Eckstrom"] <- "Hispanic or Latino, White or Caucasian"
race$race_ethnicity[race$name == "Madison Laboy"] <- "Hispanic or Latino, White or Caucasian"
race$race_ethnicity[race$name == "Tamar Farchy"] <- "Asian, White or Caucasian"
race$race_ethnicity[race$name == "Steven Guerin"] <- "Hispanic or Latino, White or Caucasian"
race$race_ethnicity[race$name == "Anna Weinstein-Perez"] <- "Hispanic or Latino, White or Caucasian"

race2 <- unique(race)
#it looks like someone put nothing ! 
              
# For student profiles
#write.csv(stu, "data/processed/rgk_students_spring_2022.csv", row.names = FALSE)  


stu4 <- stu |> 
  select(
    first_name,
    last_name,
    is_there_any_additional_information_regarding_your_availability_that_we_should_know_about,
    do_you_have_access_to_transportation,
    do_you_need_flexible_work_hours,
    do_you_need_the_ability_to_work_remotely,
    realistically_how_much_time_can_you_commit_per_week_to_working_on_a_project,
    65:92
  ) |>
    rename(
      time_commitment = realistically_how_much_time_can_you_commit_per_week_to_working_on_a_project,
      transportation = do_you_have_access_to_transportation,
      flexible_hours = do_you_need_flexible_work_hours, 
      remote = do_you_need_the_ability_to_work_remotely,
      spanish = please_rate_your_proficiency_with_the_following_language_note_1_no_proficiency_and_5_extremely_proficient_native_speaker_spanish) |> 
  mutate(nonprofit_experience = case_when(
    nonprofit_experience == "No experience (yet!)" ~ "1",
    nonprofit_experience == "Less than 6 months" ~ "2",
    nonprofit_experience == "6 - 12 months" ~ "3",
    nonprofit_experience == "1 - 2 years" ~ "4",
    nonprofit_experience == "Over 2 years" ~ "5"
  ),
  time_commitment = case_when(
    time_commitment == "Less than 5 hours per week" ~ "1",
    time_commitment == "5 - 10 hours per week" ~ "2",
    time_commitment == "8 - 12 hours per week" ~ "3",
    time_commitment == "10 - 15 hours per week" ~ "4",
    time_commitment == "15 - 20 hours per week" ~ "5"
    
  )) |> 
  mutate(across(7:33, as.numeric),
         name = paste0(first_name," ", last_name))


stumas <- stu4

stu4 <- stu4 |> 
  select(name, time_commitment, 4:35) |>  
  arrange(str_extract(name,'\\s.*$'))


#For table 
stu_table <- stu4 |> 
  select(-c(relevant_skills, target_population))

names(stu_table) <- gsub(pattern = "_",
                  replacement = " ",
                  x = names(stu_table))

names(stu_table) <- str_to_title(names(stu_table))


cell_color <- function(x) {
  x = cell_spec(x,
                color = spec_color(x, end = .7),
                bold = T,
                )
}

stu_table <- stu_table |> 
  select(-Transportation,-`Flexible Hours`, -Remote, everything()) |> 
  mutate(across(2:28, cell_color))


kbl(stu_table, escape = F) |> 
  kable_material(c("hover", "striped", "condensed"), full_width = F) |> 
  scroll_box(width = "100%", height = "400px")

```

<b style='color: #E76F51 !important;' align="center"> Overall, `r length(stu4$name)` students applied during this cohort. </b>
</br>

### Student Location 

We do not collect student addresses, but `Qualtrics` does record the longitude and latitude of where students fill out the form. Therefore, the following map is only an estimate of where our applicants live. 

```{r student_location}

stu_geo <- stu |> 
  select(first_name, last_name, location_latitude, location_longitude ) |> 
  mutate(name = paste0(first_name, " ",last_name),
         location_latitude = as.numeric(location_latitude),
         location_longitude = as.numeric(location_longitude))


# create leaflet map
stu_map <- leaflet(stu_geo) %>%
  addTiles() %>%
  addMarkers(lng = ~location_longitude,
             lat = ~location_latitude,
             popup = ~ name)

stu_map


```


### Other student information 

The following table includes students' responses to open ended questions. It's impossible to list every single skill that might be relevant for a project on the survey (although we have tried), so the relevant skills question is attempt to fill that gap. In addition, for the first time a question about target population was added to the survey. This came out of our diversity, equity, and inclusion evaluation that was conducted during our summer cohort. Students voiced their desire to specify which populations they are most interested in. As an open ended question, we can not use target population in the algorithm in its present state. However, we will have the opportunity to improve the question methodology in subsequent cohorts to give students more of a say in the organizations they work with. 

```{r desired_pop, message=FALSE, warning=FALSE, layout="l-body-outset"}
stu_table2 <- stumas |> 
  select(name, relevant_skills, target_population, is_there_any_additional_information_regarding_your_availability_that_we_should_know_about) |>
  rename(additional_information = is_there_any_additional_information_regarding_your_availability_that_we_should_know_about) |> 
  mutate(relevant_skills = replace_na(relevant_skills, ""),
         target_population = replace_na(target_population, ""),
         additional_information = replace_na(additional_information, "")) |> 
  left_join(race2, by = "name")

names(stu_table2) <- gsub(pattern = "_",
                  replacement = " ",
                  x = names(stu_table2))

names(stu_table2) <- str_to_title(names(stu_table2))

kbl(stu_table2, escape = F) |> 
  kable_minimal(c("hover"), full_width = F) |> 
  scroll_box(width = "100%", height = "400px")

```


### Student Skills

The following chart was constructed by counting every student who put at least a 2 under each skill. The most popular skills were Microsoft Office Suite and program evaluation skills. Those that selected outcomes definition and logic modeling were much fewer in comparison to program evaluation. Therefore, it might make sense next semester to remove program evaluation and focus on specific program evaluation skills. 

```{r student_skills, fig.height=6, fig.width=8, message=FALSE, warning=FALSE}


stu2 <- stu |>
  select(first_name, 66:90) |> 
  rename(spanish = "please_rate_your_proficiency_with_the_following_language_note_1_no_proficiency_and_5_extremely_proficient_native_speaker_spanish")

names(stu2) <- gsub(pattern = "_",
                   replacement = " ",
                   x = names(stu2))

names(stu2) <- str_to_title(names(stu2))

stu3 <- stu2 |>
  pivot_longer(col = 2:26,
               names_to = "Skill",
               values_to = "Rating") |>
  #Setting students who put 1 to NA
  mutate(Rating = na_if(Rating, 1)) |>
  drop_na() |>
  group_by(Skill) |>
  count()

theme_set(theme_classic())

g <- ggplot(stu3, aes(x = reorder(Skill, n), y = n, fill = n)) +
  geom_bar(stat = "identity") +
  geom_text(aes(label = n, y = n),
            position = position_stack(vjust = 0.5),
            size = 6) +
  coord_flip() +
  theme(
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_blank(),
    text = element_text(size = 16,
                        face = "bold"),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks = element_blank(),
    axis.text.x = element_blank(),
    plot.title = element_text(hjust = 0.5),
    plot.margin = margin(10, 10, 10, 10),
    legend.title = element_blank(),
    legend.position = "none"
    
  ) +
  labs(title = "Student Skills",
       caption = "**Calculated by summing skills rated as higher than 1") +
   scale_fill_distiller(palette = "RdYlGn", direction = 1) 


g

```

# Resumes Model Training 


### Methodology

After 3 years of the CONNECT program we have a lot of resumes and data. Combining the project bucket data with the resumes, I created a labeled data set. Since the first and second buckets are less technical, and the third and fourth are more so, I was able to combine them further into a binary variable, or technical classification. Then I used natural language processing and a random forest model to predict which students resumes were technical or not. The first run through had an accuracy rating of over 80%, after using cross validation. Upon closer inspection, many of those that were mislabeled were actually students who were super technical matched with a less technical project, or vice versa. There are many reason why this might have happened. Maybe the student was super technical but shared an interest with the organization, or maybe a project wound up in bucket 2 even if it only needed excel. Since the main goal of this is to assign a technical rating, it doesn't really matter if some of the student resumes were relabeled. There were a handful in each category where the algorithm clearly failed. PhD students who submitted large CV's, for example, were often mislabeled, and those were kept in there. Over all, with the changes to the labels, the algorithm performed much better. 

** NOTE! Some of the resumes were moved to different buckets in the end. The reason for this is because some of them were clearly not technical or clearly not technical, leading to lower model performance. 

### Model Prep

First we need to convert the pdfs to text. Then we preprocess the text data so that it doesn't contain punctuation or words that don't have any meaning, like the word "the" or "at". Finally, we split the data into test and train datasets 

```{r model_prep, message=FALSE, warning=FALSE}

# converting resumes to text data 

convertpdf2txt <- function(dirpath){
  files <- list.files(dirpath, full.names = T)
  x <- sapply(files, function(x){
  x <- pdftools::pdf_text(x) %>%
  paste(sep = " ") %>%
  stringr::str_replace_all(stringr::fixed("\n"), " ") %>%
  stringr::str_replace_all(stringr::fixed("\r"), " ") %>%
  stringr::str_replace_all(stringr::fixed("\t"), " ") %>%
  stringr::str_replace_all(stringr::fixed("\""), " ") %>%
  stringr::str_replace_all("[^[:alnum:]]", " ") %>% #this line removes 
    #everything that's no alphanumerica
  paste(sep = " ", collapse = " ") %>%
  stringr::str_squish() %>%
  stringr::str_replace_all("- ", "") 
  return(x)
    })
}


b1_raw <- convertpdf2txt("data/raw/resumes_bucket1/")
b1 <- as.data.frame(b1_raw) |> 
  mutate(bucket = "Bucket 1") |> 
  rename(resume = b1_raw)

b2_raw <- convertpdf2txt("data/raw/test/")
b2 <- as.data.frame(b2_raw) |> 
  mutate(bucket = "Bucket 2")  |> 
  rename(resume = b2_raw)

b3_raw <- convertpdf2txt("data/raw/resumes_bucket3/")
b3 <- as.data.frame(b3_raw) |> 
  mutate(bucket = "Bucket 3") |> 
  rename(resume = b3_raw)
b4_raw <- convertpdf2txt("data/raw/resumes_bucket4/")
b4 <- as.data.frame(b4_raw) |> 
  mutate(bucket = "Bucket 4")  |> 
  rename(resume = b4_raw)

res <- b1 |> 
  bind_rows(b2, b3, b4) |> 
  mutate(con_bucket = case_when(
    bucket == "Bucket 1" ~ "Less Technical",
    bucket == "Bucket 2" ~ "Less Technical",
    bucket == "Bucket 3" ~ "More Technical",
    bucket == "Bucket 4" ~ "More Technical",
    TRUE ~ "Other"
  ),
  bucket = factor(bucket),
  con_bucket = factor(con_bucket)) 


set.seed(27)
res_split <- initial_split(data = res, strata = con_bucket, prop = .8)
res_train <- training(res_split)
res_test <- testing(res_split)

```


### ML

Random forest was used to classify the resumes. 

```{r ml, message=FALSE, warning=FALSE}
bucket_rec <- recipe(con_bucket ~ resume, data = res_train)
bucket_rec <- bucket_rec %>%
  step_tokenize(resume) %>%
  step_stopwords(resume) %>%
  step_tokenfilter(resume, max_tokens = 500) %>%
  step_tfidf(resume)

ra_spec <- rand_forest() %>%
  set_mode("classification") %>%
  set_engine("randomForest")


ra_wf <- workflow() %>%
  add_recipe(bucket_rec) %>%
  add_model(ra_spec)

ra_wf %>%
  fit(data = res_train)



```


### Evaluating

The model has an accuracy of around 95%. NOTE this is after I moved some resumes because they were not technical. The model is best at evaluating whether a student's resume is technical or not. 

```{r eval}

res_folds <- vfold_cv(data = res_train, strata = con_bucket, v = 3)

ra_cv <- ra_wf %>%
  fit_resamples(
    res_folds,
    control = control_resamples(save_pred = TRUE),
    metrics = metric_set(recall, precision, accuracy, roc_auc)
  )

ra_cv_metrics <- collect_metrics(ra_cv)
ra_cv_predictions <- collect_predictions(ra_cv)

ra_cv_metrics


```


# Matching 

In order to use the matching Algorithm, students and organizations have to be assigned a utility ratings. These ratings are formulated by comparing how similar the students' skills and nonprofit experience are to the project expectations. 

Each student receives a utility score for each organization, and each organization is assigned a utility sore for each student. This ensures that both the student's and organization's rankings are taken into account for the matching process. For example, if an organization assigns two students the same utility score, but one student has a higher utility score for that organization, this student is selected and the other student returns to the selection pool. 

### Utility Score Example 

The following section illustrates how utility scores are formulated. The code block below was used to calculate `r stu4[1,1]`'s utility rating for `r org2[1,1]`. Each skill is compared by subtracting the student value from the organization's. If the result equals 0 or greater, that means the student's skill rating meets or exceeds what the organization's project requires and the skill receives a utility rating of 1. If the result is a negative number, that means the organizations requirements exceed what the student put on their survey form, and they receive a utility rating less than one, depending on how far the student's answer was from the organizations. 

Additionally, if a student put a 1 on a skill, which means they have no background in it, they automatically receive a zero utility rating. Students who don't match the organization based on the logistics questions, also receive a utility rating of zero. 

Finally, all of the skill utility ratings are added up to produce one utility rating for `r stu4[1,1]` and `r org2[1,1]`. The higher the number, the greater the utility the student will have for that project. 


** Note! The skills must be named the same thing otherwise it will not work 

```{r testing_utility, echo=TRUE, message=FALSE, warning=FALSE}


#Initial Data Manipulation
org1 <- org3[1, ] |>
  pivot_longer(9:34, names_to = "variable", values_to = "org_value")
stu1 <- stu4[1, ] |>
  pivot_longer(6:31, names_to = "variable", values_to = "student_value")

#Assigning a utility score for each skill
match1 <- left_join(org1, stu1, by = "variable") |>
  mutate(
    subtracted = student_value - org_value,
    utility = case_when(
      subtracted >= 0 ~ 1,
      subtracted == -1 ~ .75,
      subtracted == -2 ~ .5,
      subtracted == -3 ~ .25,
      subtracted == -4 ~ 0
    ),
    #if the student put 1 on their survey it means
    #they would provide 0 utility for that skills 
    utility = case_when(
      student_value == 1 ~ 0,
      TRUE ~ utility),
    #If the students logistics don't match up with the orgs
    #Then the utility for that student changes to 0
    utility = case_when(
      transportation.x == "Yes" & transportation.y == "No" ~ 0,
      flexible_hours.x == "No" & flexible_hours.y == "Yes" ~ 0,
      remote.x == "No" & remote.y == "Yes" ~ 0,
      TRUE ~ utility
    ),#If the orgs time commitment is greater than what the student
    #is willing to work their utility is set to 0
    utility = case_when(
      time_commitment.x > time_commitment.y ~ 0,
      TRUE ~ utility
    )
  ) 

utility_score <- sum(match1$utility)
print(paste0(stu1[1,1],"'s utility for ",org1[1,1], ": ", utility_score))
```

### Prematches

```{r prematches}

stu4 <- stu4 |> 
  filter(name != "Brie Winnega Reamer",
         name != "Ziyue Xu",
         name != "Francisco Castellanos-Sosa",
         name != "Rania Sahail",
         name != "Abigail Grider-Reidf")

org3 <- org3 |> 
  filter(organization != "Texas Census 2030",
         organization != "Austin Asian Impact",
         organization != "Keep Austin Fed")


```


```{r student_utility, message=FALSE, warning=FALSE, include=FALSE}

#utility students                                    
column_names <- stu4$name
row_names <- org3$organization

uS <- matrix(nrow = length(org3$project_name),
             ncol = length(stu4$name),
             dimnames = list(row_names, column_names))

for (i in 1:length(org3$project_name)) {
  for (j in 1:length(stu4$name)) {
    org1 <- org3[i, ] |>
      pivot_longer(9:34, names_to = "variable", values_to = "org_value")
    
    stu1 <- stu4[j, ] |>
      pivot_longer(6:31, names_to = "variable", values_to = "student_value")
    
    match1 <- left_join(org1, stu1, by = "variable") |>
      mutate(
        subtracted = student_value - org_value,
        utility = case_when(
          subtracted >= 0 ~ 1,
          subtracted == -1 ~ .75,
          subtracted == -2 ~ .5,
          subtracted == -3 ~ .25,
          subtracted <= -4 ~ 0
        ),
        utility = case_when(
          student_value == 1 ~ 0,
          TRUE ~ utility),
        utility = case_when(
          transportation.x == "Yes" & transportation.y == "No" ~ 0,
          flexible_hours.x == "No" & flexible_hours.y == "Yes" ~ 0,
          remote.x == "No" & remote.y == "Yes" ~ 0,
          TRUE ~ utility
        ),
        utility = case_when(time_commitment.x > time_commitment.y ~ 0,
                            TRUE ~ utility)
      )
    
    utility_score <- sum(match1$utility)
    uS[i,j] <- utility_score
  }
  
}

kbl(uS, escape = F) |> 
  kable_material(c("hover", "striped", "condensed"), full_width = F) |> 
  scroll_box(width = "100%", height = "400px")

```
### Organization Utility Scores

For simplicity sake, only the organization utility scores are shown below because their preference matters more in the event of an unsuitable first match. Higher organization utility scores mean that the student is better suited to the organization's project. These ratings can be validated by reviewing students resumes when necessary.


```{r org_utility, message=FALSE, warning=FALSE, layout="l-body-outset"}
#utility organizations  
row_names <- stu4$name
column_names <- org3$project_name

uO <- matrix(nrow = length(stu4$name),
             ncol = length(org3$project_name),
             dimnames = list(row_names, column_names))


for (j in 1:length(stu4$name)) {
  for (i in 1:length(org3$project_name)) {
    org1 <- org3[i,] |>
      pivot_longer(9:34, names_to = "variable", values_to = "org_value")
    
    stu1 <- stu4[j,] |>
      pivot_longer(6:31, names_to = "variable", values_to = "student_value")
    
    match1 <- left_join(org1, stu1, by = "variable") |>
      mutate(
        subtracted =  org_value - student_value,
        utility = case_when(
          subtracted <= 0 ~ 1,
          subtracted == 1 ~ .75,
          subtracted == 2 ~ .5,
          subtracted == 3 ~ .25,
          subtracted >= 4 ~ 0
        ),
        utility = case_when(
          org_value == 1 ~ 0,
          TRUE ~ utility),
        utility = case_when(
          transportation.x == "Yes" & transportation.y == "No" ~ 0,
          flexible_hours.x == "No" & flexible_hours.y == "Yes" ~ 0,
          remote.x == "No" & remote.y == "Yes" ~ 0,
          TRUE ~ utility
        ),
        utility = case_when(time_commitment.x > time_commitment.y ~ 0,
                            TRUE ~ utility)
      )
    
    utility_score <- sum(match1$utility)
    uO[j, i] <- utility_score
  }
}

#Table Styling 
cell_color <- function(x) {
  x = cell_spec(x,
                color = spec_color(x, end = .7),
                bold = T,
                )
}


uO_table <- as.data.frame(uO) |> 
  mutate(across(1:17, cell_color))


kbl(uO_table, escape = F) |> 
  kable_material(c("hover", "striped", "condensed"), full_width = F) |> 
  scroll_box(width = "100%", height = "400px")
```
</br>

### The Gale Shapley Algorithm

The `matchingR` package was used to quickly compute the Gale-Shapley algorithm. The algorithm was devised to create satisfactory matches between two parties, in this case between organizations and students. It has been used commercially on match making websites, in college admissions, and by the healthcare industry to match organ donors with organ recipients. The former being the major impetus for the creators to receive the Nobel Prize in Economics in 2012. You can find a full description of the package and literature behind the Gale-Shapley algorithm [here](https://cran.r-project.org/web/packages/matchingR/vignettes/matchingR-intro.html).

```{r gale_shapley, echo=FALSE, message=TRUE, warning=FALSE}

#Matching Algorithm 
matching = galeShapley.marriageMarket(uS, uO)

```

### Matching Results

The table below shows the matching results. Matches should be validated by reviewing student resumes to ensure they have relevant work experience. The table also shows a list of all the top scorers for each project. Program managers can use this list to help them find a match if the first wasn't suitable.

```{r results, message=FALSE, warning=FALSE, layout="l-body-outset"}

#Creating a list of top scorers
uO2 <- as.data.frame(uO)
org_options <- tibble::rownames_to_column(uO2, "Student") 
tops <- list()

for (i in 2:ncol(org_options)) {
  org_top <- org_options |> 
    slice_max(org_options[,i], n = 3)
  
tops[[i]] <- paste(org_top$Student, collapse=", ") 
}

tops <- tops[-1]
top_df <- data.frame(matrix(unlist(tops), nrow=length(tops), byrow=TRUE))

top_df$matrix.unlist.tops...nrow...length.tops...byrow...TRUE.<-
  gsub("\\."," ",top_df$matrix.unlist.tops...nrow...length.tops...byrow...TRUE.)

#Creating a data frame for table 
org_info <- org3 |> 
  select(project_name)

students_matched <- stu4 |> 
  slice(matching$engagements) |> 
  bind_cols(org_info) |>  
  bind_cols(top_df) |> 
  rename(Student = name, 
         Project = project_name,
         "Top Scores" = "matrix.unlist.tops...nrow...length.tops...byrow...TRUE.") |> 
  select(Project, Student,"Top Scores")
  

var_label(students_matched$Project) <- NULL


kbl(students_matched) |> 
  kable_material(c("hover","striped"), full_width = F) |> 
  scroll_box(width = "100%", height = "600px")

```

<br>


# Matching with NLP


```{r modifying data}

#pulling the bucket information
tech <- org2 |> 
  select(organization, starts_with("identify_the_categories")) |> 
   rename_with(~ gsub('identify_the_categories_your_project_falls_under_check_all_that_apply_', '', .x)) |>
  pivot_longer(cols = 2:7, names_to = "bucket", values_to = "value") |> 
  filter(!is.na(value),
         value != "Data Collection & Tool Development" &
         value != "Measurement Strategy",
         value != "Research") |> 
  select(organization, value)

#joining org score with technical 
org_nlp <- org3 |> 
  left_join(tech, by = "organization") |> 
  mutate(technical = case_when(
    is.na(value) ~ "Less Technical",
    TRUE ~ "More Technical"
  )) |> 
  select(-value)

```


# Reading in student resumes 

Unfortunately the qualtrics api doesn't not read in uploaded files yet

```{r resumes}

```





<img src="C:/Users/tenis/Desktop/Data_Projects/connect_matching/reports/RGB_formal_RGK.png" alt="RGK Center">

